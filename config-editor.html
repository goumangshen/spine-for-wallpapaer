<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é…ç½®ç¼–è¾‘å™¨</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header h1 {
      font-size: 24px;
      font-weight: 600;
    }

    .header-actions {
      display: flex;
      gap: 10px;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
    }

    .btn-primary {
      background: white;
      color: #667eea;
    }

    .btn-primary:hover {
      background: #f0f0f0;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .content {
      padding: 30px;
    }

    .nav-sidebar {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 280px;
      max-height: calc(100vh - 100px);
      overflow-y: auto;
      background: white;
      border: 2px solid #667eea;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      opacity: 0;
      visibility: hidden;
      transform: translateY(20px);
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .nav-trigger-area {
      position: fixed;
      bottom: 0;
      right: 0;
      width: 120px;
      height: 120px;
      z-index: 998;
      pointer-events: auto;
    }

    .nav-sidebar.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .nav-trigger-hint {
      position: fixed;
      bottom: 10px;
      right: 10px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: rgba(102, 126, 234, 0.1);
      border: 2px dashed #667eea;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #667eea;
      font-size: 24px;
      pointer-events: none;
      z-index: 997;
      transition: all 0.3s;
    }

    .nav-sidebar.show~.nav-trigger-hint,
    .nav-trigger-area:hover~.nav-trigger-hint {
      opacity: 0;
    }

    .nav-sidebar h3 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 15px;
      color: #667eea;
      padding-bottom: 10px;
      border-bottom: 2px solid #667eea;
      position: sticky;
      top: 0;
      background: white;
      z-index: 10;
    }

    .nav-menu {
      list-style: none;
    }

    .nav-menu li {
      margin-bottom: 8px;
    }

    .nav-menu a {
      display: block;
      padding: 8px 12px;
      color: #555;
      text-decoration: none;
      border-radius: 4px;
      transition: all 0.2s;
      font-size: 14px;
    }

    .nav-menu a:hover {
      background: #e8e8e8;
      color: #667eea;
    }

    .nav-menu a.nav-top {
      font-weight: 600;
      color: #667eea;
    }

    .nav-menu .nav-submenu {
      margin-left: 20px;
      margin-top: 5px;
    }

    .nav-menu .nav-submenu a {
      font-size: 13px;
      padding: 6px 12px;
      color: #777;
    }

    .nav-menu .nav-submenu a:hover {
      color: #667eea;
    }

    .form-section {
      margin-bottom: 30px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      background: #fafafa;
      scroll-margin-top: 100px;
    }

    .form-section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #333;
      padding-bottom: 10px;
      border-bottom: 2px solid #667eea;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #555;
      font-size: 14px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
      font-family: 'Courier New', monospace;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .array-item {
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 10px;
      position: relative;
    }

    .array-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }

    .array-item-title {
      font-weight: 600;
      color: #667eea;
    }

    .btn-remove {
      background: #ff4757;
      color: white;
      padding: 5px 12px;
      font-size: 12px;
    }

    .btn-remove:hover {
      background: #ff3838;
    }

    .btn-add {
      background: #2ed573;
      color: white;
      padding: 8px 16px;
      margin-top: 10px;
    }

    .btn-add:hover {
      background: #26d467;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .checkbox-group input[type="checkbox"] {
      width: auto;
    }

    .file-input-wrapper {
      position: relative;
      display: inline-block;
    }

    .file-input-wrapper input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }

    .nested-section {
      margin-left: 20px;
      margin-top: 15px;
      padding-left: 20px;
      border-left: 3px solid #667eea;
      scroll-margin-top: 120px;
    }

    .array-item {
      scroll-margin-top: 120px;
    }

    .collapsible {
      cursor: pointer;
      user-select: none;
    }

    .collapsible::before {
      content: 'â–¼';
      display: inline-block;
      margin-right: 8px;
      transition: transform 0.3s;
    }

    .collapsible.collapsed::before {
      transform: rotate(-90deg);
    }

    .collapsible-content {
      overflow: hidden;
      transition: max-height 0.3s;
    }

    .collapsible-content.collapsed {
      max-height: 0;
    }

    .hidden {
      display: none;
    }

    .string-array-input {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .string-array-item {
      display: flex;
      gap: 5px;
    }

    .string-array-item input {
      flex: 1;
    }

    .number-range-input {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .info-text {
      font-size: 12px;
      color: #888;
      margin-top: 5px;
    }
  </style>
</head>

<body>
  <div class="container" id="top">
    <div class="header">
      <h1>é…ç½®ç¼–è¾‘å™¨</h1>
      <div class="header-actions">
        <input type="file" id="importFile" accept=".json" style="display: none;">
        <button class="btn-secondary" onclick="document.getElementById('importFile').click()">å¯¼å…¥ JSON</button>
        <button class="btn-primary" onclick="exportConfig()">å¯¼å‡º JSON</button>
      </div>
    </div>

    <div class="content" id="formContainer">
      <!-- è¡¨å•å†…å®¹å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
    </div>
    <div class="nav-trigger-area"></div>
    <div class="nav-trigger-hint">ğŸ“‹</div>
    <div class="nav-sidebar" id="navSidebar">
      <h3>å¿«é€Ÿå¯¼èˆª</h3>
      <ul class="nav-menu" id="navMenu">
        <li><a href="#top" class="nav-top">è¿”å›é¡¶éƒ¨</a></li>
      </ul>
    </div>
  </div>

  <script>
    // é…ç½®æ•°æ®ç»“æ„å®šä¹‰
    const configSchema = {
      width: { type: 'number', required: true, label: 'å®½åº¦' },
      height: { type: 'number', required: true, label: 'é«˜åº¦' },
      backgroundImage: { type: 'stringOrArray', label: 'èƒŒæ™¯å›¾ç‰‡' },
      backgroundImageFit: { type: 'select', label: 'èƒŒæ™¯å›¾é€‚é…æ–¹å¼', options: ['height', 'width', 'auto'] },
      canvasAlignLeftPercent: { type: 'number', label: 'Canvas å·¦å¯¹é½ç™¾åˆ†æ¯”' },
      canvasAlignRightPercent: { type: 'number', label: 'Canvas å³å¯¹é½ç™¾åˆ†æ¯”' },
      canvasEdgeTransition: { type: 'select', label: 'Canvas è¾¹ç¼˜è¿‡æ¸¡æ–¹å¼', options: [0, 1, 2, 3] },
      canvasEdgeTransitionImage: { type: 'string', label: 'Canvas è¾¹ç¼˜è¿‡æ¸¡å›¾ç‰‡' },
      canvasEdgeBorderColor: { type: 'string', label: 'Canvas è¾¹æ¡†é¢œè‰²' },
      backgroundMusic: {
        type: 'object',
        label: 'èƒŒæ™¯éŸ³ä¹',
        fields: {
          fileName: { type: 'string', label: 'æ–‡ä»¶å', required: true },
          volume: { type: 'number', label: 'éŸ³é‡ (0-1)' }
        }
      },
      animationMix: {
        type: 'object',
        label: 'åŠ¨ç”»æ··åˆ',
        fields: {
          enabled: { type: 'boolean', label: 'å¯ç”¨' },
          duration: { type: 'number', label: 'æ··åˆæ—¶é—´ï¼ˆç§’ï¼‰' }
        }
      },
      specialEffectLibrary: {
        type: 'array',
        label: 'ç‰¹æ®Šç‰¹æ•ˆåº“',
        itemType: 'specialEffect'
      },
      meshes: {
        type: 'array',
        label: 'Mesh é…ç½®',
        required: true,
        itemType: 'mesh'
      },
      activeMeshIndex: { type: 'number', label: 'ç”Ÿæ•ˆçš„ Mesh ç´¢å¼•' }
    };

    let formData = {};

    // åˆå§‹åŒ–è¡¨å•
    function initForm() {
      const container = document.getElementById('formContainer');
      container.innerHTML = '';

      Object.keys(configSchema).forEach(key => {
        const schema = configSchema[key];
        const element = createFormElement(key, schema, formData[key]);
        container.appendChild(element);
      });

      // æ›´æ–°å¯¼èˆªèœå•
      updateNavigation();

      // åˆå§‹åŒ–å¯¼èˆªæ æ˜¾ç¤º/éšè—æ§åˆ¶
      initNavigationControls();
    }

    // åˆå§‹åŒ–å¯¼èˆªæ æ§åˆ¶ï¼ˆåªè°ƒç”¨ä¸€æ¬¡ï¼Œä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼‰
    let navigationControlsInitialized = false;
    function initNavigationControls() {
      if (navigationControlsInitialized) return;
      navigationControlsInitialized = true;

      const triggerArea = document.querySelector('.nav-trigger-area');
      const navSidebar = document.getElementById('navSidebar');

      if (!triggerArea || !navSidebar) return;

      let hideTimeout;

      // é¼ æ ‡ç§»åŠ¨åˆ°å³ä¸‹è§’è§¦å‘åŒºåŸŸæ—¶æ˜¾ç¤ºå¯¼èˆªæ 
      triggerArea.addEventListener('mouseenter', () => {
        clearTimeout(hideTimeout);
        navSidebar.classList.add('show');
      });

      triggerArea.addEventListener('mouseleave', () => {
        hideTimeout = setTimeout(() => {
          if (!navSidebar.matches(':hover')) {
            navSidebar.classList.remove('show');
          }
        }, 100);
      });

      // é¼ æ ‡ç§»åŠ¨åˆ°å¯¼èˆªæ æ—¶ä¿æŒæ˜¾ç¤º
      navSidebar.addEventListener('mouseenter', () => {
        clearTimeout(hideTimeout);
        navSidebar.classList.add('show');
      });

      // é¼ æ ‡ç¦»å¼€å¯¼èˆªæ æ—¶éšè—
      navSidebar.addEventListener('mouseleave', () => {
        hideTimeout = setTimeout(() => {
          navSidebar.classList.remove('show');
        }, 300);
      });

      // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†å¯¼èˆªé“¾æ¥ç‚¹å‡»
      navSidebar.addEventListener('click', (e) => {
        if (e.target.tagName === 'A') {
          setTimeout(() => {
            navSidebar.classList.remove('show');
          }, 500);
        }
      });
    }

    // æ›´æ–°å¯¼èˆªèœå•
    function updateNavigation() {
      const navMenu = document.getElementById('navMenu');
      if (!navMenu) return;

      // 1. æ¸…ç©ºå¯¼èˆªï¼ˆä¿ç•™è¿”å›é¡¶éƒ¨ï¼‰
      navMenu.innerHTML = '<li><a href="#top" class="nav-top">è¿”å›é¡¶éƒ¨</a></li>';

      /**
       * =========================
       * ç‰¹æ®Šç‰¹æ•ˆåº“
       * =========================
       */
      const specialEffectSection = document.getElementById('section-specialEffectLibrary');
      if (specialEffectSection) {
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = '#section-specialEffectLibrary';
        a.textContent = 'ç‰¹æ®Šç‰¹æ•ˆåº“';
        li.appendChild(a);
        navMenu.appendChild(li);
      }

      /**
       * =========================
       * Mesh å¯¼èˆªï¼ˆå…³é”®ä¿®å¤ï¼‰
       * =========================
       */
      const meshesSection = document.getElementById('section-meshes');
      const meshesContainer = document.getElementById('array-meshes');

      if (!meshesSection || !meshesContainer) return;

      /**
       * 2. åªè·å–ã€Œé¡¶å±‚ Meshã€
       *    âŒ ä¸å†ä½¿ç”¨ .querySelectorAll('.array-item')
       */
      const meshItems = Array.from(meshesContainer.children).filter(el =>
        el.classList.contains('array-item')
      );

      meshItems.forEach((meshItem, meshIndex) => {
        /**
         * 3. å¼ºåˆ¶é‡æ’ Mesh IDï¼ˆæ ¸å¿ƒï¼‰
         */
        const meshId = `meshes-${meshIndex}`;
        meshItem.id = meshId;

        // Mesh ä¸»å¯¼èˆª
        const meshLi = document.createElement('li');
        const meshLink = document.createElement('a');
        meshLink.href = `#${meshId}`;
        meshLink.textContent = `Mesh #${meshIndex + 1}`;
        meshLi.appendChild(meshLink);

        /**
         * å­å¯¼èˆª
         */
        const submenu = document.createElement('ul');
        submenu.className = 'nav-submenu';

        const subSections = [
          { suffix: 'slotClickEffects', label: 'æ’æ§½ä¸“å±ç‚¹å‡»ç‰¹æ•ˆ' },
          { suffix: 'clickEffects', label: 'ç‚¹å‡»ç‰¹æ•ˆ' },
          { suffix: 'overlayMedia', label: 'è¦†ç›–åª’ä½“' },
          { suffix: 'specialEffectTriggers', label: 'ç‰¹æ®Šç‰¹æ•ˆè§¦å‘' },
          { suffix: 'slotHideRules', label: 'æ’æ§½éšè—è§„åˆ™' }
        ];

        subSections.forEach(({ suffix, label }) => {
          const subId = `${meshId}-${suffix}`;
          const subSection = document.getElementById(subId);

          if (subSection) {
            const subLi = document.createElement('li');
            const subA = document.createElement('a');
            subA.href = `#${subId}`;
            subA.textContent = label;
            subLi.appendChild(subA);
            submenu.appendChild(subLi);
          }
        });

        if (submenu.children.length > 0) {
          meshLi.appendChild(submenu);
        }

        navMenu.appendChild(meshLi);
      });
    }


    // åˆ›å»ºè¡¨å•å…ƒç´ 
    function createFormElement(key, schema, value) {
      const group = document.createElement('div');
      group.className = 'form-group';

      if (schema.type === 'object') {
        return createObjectField(key, schema, value);
      } else if (schema.type === 'array') {
        return createArrayField(key, schema, value);
      } else {
        return createSimpleField(key, schema, value);
      }
    }

    // åˆ›å»ºç®€å•å­—æ®µ
    function createSimpleField(key, schema, value) {
      const group = document.createElement('div');
      group.className = 'form-group';

      const label = document.createElement('label');
      label.textContent = schema.label || key;
      if (schema.required) label.textContent += ' *';
      group.appendChild(label);

      let input;

      if (schema.type === 'select') {
        input = document.createElement('select');
        input.id = key;
        schema.options.forEach(opt => {
          const option = document.createElement('option');
          option.value = opt;
          option.textContent = opt;
          if (value === opt) option.selected = true;
          input.appendChild(option);
        });
      } else if (schema.type === 'boolean') {
        const wrapper = document.createElement('div');
        wrapper.className = 'checkbox-group';
        input = document.createElement('input');
        input.type = 'checkbox';
        input.id = key;
        input.checked = value === true;
        wrapper.appendChild(input);
        wrapper.appendChild(document.createTextNode('å¯ç”¨'));
        group.appendChild(wrapper);
        return group;
      } else if (schema.type === 'stringOrArray') {
        input = document.createElement('textarea');
        input.id = key;
        input.placeholder = 'è¾“å…¥å­—ç¬¦ä¸²æˆ– JSON æ•°ç»„ï¼Œä¾‹å¦‚: "image.png" æˆ– ["img1.png", "img2.png"]';
        if (value !== undefined) {
          input.value = Array.isArray(value) ? JSON.stringify(value) : value;
        }
      } else {
        input = document.createElement('input');
        input.id = key;
        input.type = schema.type === 'number' ? 'number' : 'text';
        if (value !== undefined) input.value = value;
      }

      input.addEventListener('input', () => updateFormData());
      group.appendChild(input);

      return group;
    }

    // åˆ›å»ºå¯¹è±¡å­—æ®µ
    function createObjectField(key, schema, value) {
      const section = document.createElement('div');
      section.className = 'form-section';
      section.id = `section-${key}`;

      const title = document.createElement('div');
      title.className = 'form-section-title';
      title.textContent = schema.label || key;
      section.appendChild(title);

      const content = document.createElement('div');
      content.className = 'nested-section';

      Object.keys(schema.fields).forEach(fieldKey => {
        const fieldSchema = schema.fields[fieldKey];
        const fieldGroup = createFormElement(`${key}.${fieldKey}`, fieldSchema, value?.[fieldKey]);
        content.appendChild(fieldGroup);
      });

      section.appendChild(content);
      return section;
    }

    // åˆ›å»ºæ•°ç»„å­—æ®µ
    function createArrayField(key, schema, value) {
      const section = document.createElement('div');
      section.className = 'form-section';
      section.id = `section-${key}`;

      const title = document.createElement('div');
      title.className = 'form-section-title';
      title.textContent = schema.label || key;
      if (schema.required) title.textContent += ' *';
      section.appendChild(title);

      const container = document.createElement('div');
      container.id = `array-${key}`;

      const items = value || [];
      items.forEach((item, index) => {
        container.appendChild(createArrayItem(key, schema.itemType, item, index));
      });

      const addBtn = document.createElement('button');
      addBtn.type = 'button';
      addBtn.className = 'btn-add';
      addBtn.textContent = `æ·»åŠ  ${schema.label || key} é¡¹`;
      addBtn.onclick = () => {
        const newItem = getDefaultValueForType(schema.itemType);
        container.appendChild(createArrayItem(key, schema.itemType, newItem, items.length));
        updateFormData();
        updateNavigation(); // æ›´æ–°å¯¼èˆªèœå•
      };

      section.appendChild(container);
      section.appendChild(addBtn);

      return section;
    }

    // åˆ›å»ºæ•°ç»„é¡¹
    function createArrayItem(arrayKey, itemType, item, index) {
      const itemDiv = document.createElement('div');
      itemDiv.className = 'array-item';

      if (itemType === 'mesh') {
        itemDiv.classList.add('mesh-item');
      }

      itemDiv.id = `${arrayKey}-${index}`;


      const header = document.createElement('div');
      header.className = 'array-item-header';

      const title = document.createElement('div');
      title.className = 'array-item-title';
      title.textContent = `${itemType === 'mesh' ? 'Mesh' : itemType === 'specialEffect' ? 'ç‰¹æ•ˆ' : 'é¡¹'} #${index + 1}`;
      header.appendChild(title);

      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'btn-remove';
      removeBtn.textContent = 'åˆ é™¤';
      removeBtn.onclick = () => {
        itemDiv.remove();
        updateFormData();
        updateNavigation(); // æ›´æ–°å¯¼èˆªèœå•
      };
      header.appendChild(removeBtn);

      itemDiv.appendChild(header);

      const content = document.createElement('div');
      if (itemType === 'mesh') {
        content.appendChild(createMeshFields(arrayKey, index, item));
      } else if (itemType === 'specialEffect') {
        content.appendChild(createSpecialEffectFields(arrayKey, index, item));
      }
      itemDiv.appendChild(content);

      return itemDiv;
    }

    // åˆ›å»º Mesh å­—æ®µ
    function createMeshFields(arrayKey, index, mesh) {
      const container = document.createElement('div');

      const fields = [
        { key: 'type', type: 'select', label: 'ç±»å‹', options: ['spine'], value: mesh?.type || 'spine' },
        { key: 'scale', type: 'number', label: 'ç¼©æ”¾', value: mesh?.scale },
        { key: 'skeletonFileName', type: 'string', label: 'Skeleton æ–‡ä»¶å', value: mesh?.skeletonFileName },
        { key: 'jsonFileName', type: 'string', label: 'JSON æ–‡ä»¶å', value: mesh?.jsonFileName },
        { key: 'atlasFileName', type: 'string', label: 'Atlas æ–‡ä»¶å', value: mesh?.atlasFileName },
        { key: 'animationName', type: 'string', label: 'åŠ¨ç”»åç§°ï¼ˆæ—§ç‰ˆï¼‰', value: mesh?.animationName },
        { key: 'backgroundImage', type: 'stringOrArray', label: 'èƒŒæ™¯å›¾ç‰‡', value: mesh?.backgroundImage },
        { key: 'width', type: 'number', label: 'Canvas å®½åº¦', value: mesh?.width },
        { key: 'height', type: 'number', label: 'Canvas é«˜åº¦', value: mesh?.height },
        { key: 'canvasAlignLeftPercent', type: 'number', label: 'Canvas å·¦å¯¹é½ç™¾åˆ†æ¯”', value: mesh?.canvasAlignLeftPercent },
        { key: 'canvasAlignRightPercent', type: 'number', label: 'Canvas å³å¯¹é½ç™¾åˆ†æ¯”', value: mesh?.canvasAlignRightPercent },
        { key: 'canvasEdgeTransition', type: 'select', label: 'Canvas è¾¹ç¼˜è¿‡æ¸¡æ–¹å¼', options: [0, 1, 2, 3], value: mesh?.canvasEdgeTransition },
        { key: 'canvasEdgeTransitionImage', type: 'string', label: 'Canvas è¾¹ç¼˜è¿‡æ¸¡å›¾ç‰‡', value: mesh?.canvasEdgeTransitionImage },
        { key: 'canvasEdgeBorderColor', type: 'string', label: 'Canvas è¾¹æ¡†é¢œè‰²', value: mesh?.canvasEdgeBorderColor },
        { key: 'premultipliedAlpha', type: 'boolean', label: 'é¢„ä¹˜Alphaé€šé“', value: mesh?.premultipliedAlpha },
        { key: 'alphaTest', type: 'number', label: 'Alphaæµ‹è¯•é˜ˆå€¼', value: mesh?.alphaTest },
        { key: 'backgroundImageSwitchSlot', type: 'stringOrArray', label: 'èƒŒæ™¯å›¾ç‰‡åˆ‡æ¢æ’æ§½', value: mesh?.backgroundImageSwitchSlot },
        { key: 'hiddenSlots', type: 'stringOrArray', label: 'éšè—æ’æ§½', value: mesh?.hiddenSlots }
      ];

      fields.forEach(field => {
        const group = createFieldGroup(`${arrayKey}[${index}].${field.key}`, field.label, field.type, field.value, field.options);
        container.appendChild(group);
      });

      // Position
      const positionSection = document.createElement('div');
      positionSection.className = 'nested-section';
      positionSection.innerHTML = '<div class="form-section-title" style="font-size: 14px; margin-bottom: 10px;">ä½ç½®</div>';
      ['x', 'y', 'z'].forEach(axis => {
        const group = createFieldGroup(`${arrayKey}[${index}].position.${axis}`, axis.toUpperCase(), 'number', mesh?.position?.[axis]);
        positionSection.appendChild(group);
      });
      container.appendChild(positionSection);

      // Animations
      const animSection = document.createElement('div');
      animSection.className = 'nested-section';
      animSection.innerHTML = '<div class="form-section-title" style="font-size: 14px; margin-bottom: 10px;">åŠ¨ç”»é…ç½®</div>';
      const animContainer = document.createElement('div');
      animContainer.id = `animations-${arrayKey}-${index}`;
      (mesh?.animations || []).forEach((anim, animIndex) => {
        animContainer.appendChild(createAnimationItem(arrayKey, index, animIndex, anim));
      });
      const addAnimBtn = document.createElement('button');
      addAnimBtn.type = 'button';
      addAnimBtn.className = 'btn-add';
      addAnimBtn.textContent = 'æ·»åŠ åŠ¨ç”»';
      addAnimBtn.onclick = () => {
        animContainer.appendChild(createAnimationItem(arrayKey, index, animContainer.children.length, {}));
        updateFormData();
        updateNavigation();
      };
      animSection.appendChild(animContainer);
      animSection.appendChild(addAnimBtn);
      container.appendChild(animSection);

      // Control Slots
      const controlSection = document.createElement('div');
      controlSection.className = 'nested-section';
      controlSection.innerHTML = '<div class="form-section-title" style="font-size: 14px; margin-bottom: 10px;">æ§åˆ¶æ’æ§½</div>';
      const bgMusicGroup = createFieldGroup(`${arrayKey}[${index}].controlSlots.backgroundMusic`, 'èƒŒæ™¯éŸ³ä¹æ’æ§½', 'stringOrArray', mesh?.controlSlots?.backgroundMusic);
      const voiceAnimGroup = createFieldGroup(`${arrayKey}[${index}].controlSlots.voiceAnimation`, 'è¯­éŸ³åŠ¨ç”»æ’æ§½', 'stringOrArray', mesh?.controlSlots?.voiceAnimation);
      controlSection.appendChild(bgMusicGroup);
      controlSection.appendChild(voiceAnimGroup);
      container.appendChild(controlSection);

      // Click Effects
      const clickEffectsSection = document.createElement('div');
      clickEffectsSection.className = 'nested-section';
      clickEffectsSection.id = `${arrayKey}-${index}-clickEffects`;
      const clickEffectsTitle = document.createElement('div');
      clickEffectsTitle.className = 'form-section-title';
      clickEffectsTitle.style.fontSize = '14px';
      clickEffectsTitle.style.marginBottom = '10px';
      clickEffectsTitle.textContent = 'ç‚¹å‡»ç‰¹æ•ˆ';
      clickEffectsSection.appendChild(clickEffectsTitle);
      const clickEffectsContainer = document.createElement('div');
      clickEffectsContainer.id = `clickEffects-${arrayKey}-${index}`;
      (mesh?.clickEffects || []).forEach((effect, effectIndex) => {
        clickEffectsContainer.appendChild(createClickEffectItem(arrayKey, index, effectIndex, effect));
      });
      const addClickEffectBtn = document.createElement('button');
      addClickEffectBtn.type = 'button';
      addClickEffectBtn.className = 'btn-add';
      addClickEffectBtn.textContent = 'æ·»åŠ ç‚¹å‡»ç‰¹æ•ˆ';
      addClickEffectBtn.onclick = () => {
        clickEffectsContainer.appendChild(createClickEffectItem(arrayKey, index, clickEffectsContainer.children.length, {}));
        updateFormData();
        updateNavigation();
      };
      clickEffectsSection.appendChild(clickEffectsContainer);
      clickEffectsSection.appendChild(addClickEffectBtn);
      container.appendChild(clickEffectsSection);

      // Slot Click Effectsï¼ˆæ’æ§½ä¸“å±ç‚¹å‡»ç‰¹æ•ˆï¼‰
      const slotClickEffectsSection = document.createElement('div');
      slotClickEffectsSection.className = 'nested-section';
      slotClickEffectsSection.id = `${arrayKey}-${index}-slotClickEffects`;

      const slotClickEffectsTitle = document.createElement('div');
      slotClickEffectsTitle.className = 'form-section-title';
      slotClickEffectsTitle.style.fontSize = '14px';
      slotClickEffectsTitle.style.marginBottom = '10px';
      slotClickEffectsTitle.textContent = 'æ’æ§½ä¸“å±ç‚¹å‡»ç‰¹æ•ˆ';
      slotClickEffectsSection.appendChild(slotClickEffectsTitle);

      const slotClickEffectsContainer = document.createElement('div');
      slotClickEffectsContainer.id = `slotClickEffects-${arrayKey}-${index}`;

      (mesh?.slotClickEffects || []).forEach((item, itemIndex) => {
        slotClickEffectsContainer.appendChild(
          createSlotClickEffectItem(arrayKey, index, itemIndex, item)
        );
      });

      const addSlotClickEffectBtn = document.createElement('button');
      addSlotClickEffectBtn.type = 'button';
      addSlotClickEffectBtn.className = 'btn-add';
      addSlotClickEffectBtn.textContent = 'æ·»åŠ æ’æ§½ç‚¹å‡»ç‰¹æ•ˆ';
      addSlotClickEffectBtn.onclick = () => {
        slotClickEffectsContainer.appendChild(
          createSlotClickEffectItem(
            arrayKey,
            index,
            slotClickEffectsContainer.children.length,
            {}
          )
        );
        updateFormData();
        updateNavigation();
      };

      slotClickEffectsSection.appendChild(slotClickEffectsContainer);
      slotClickEffectsSection.appendChild(addSlotClickEffectBtn);
      container.appendChild(slotClickEffectsSection);


      // Overlay Media
      const overlaySection = document.createElement('div');
      overlaySection.className = 'nested-section';
      overlaySection.id = `${arrayKey}-${index}-overlayMedia`;
      const overlayTitle = document.createElement('div');
      overlayTitle.className = 'form-section-title';
      overlayTitle.style.fontSize = '14px';
      overlayTitle.style.marginBottom = '10px';
      overlayTitle.textContent = 'è¦†ç›–åª’ä½“';
      overlaySection.appendChild(overlayTitle);
      const overlayContainer = document.createElement('div');
      overlayContainer.id = `overlayMedia-${arrayKey}-${index}`;
      const overlayArray = Array.isArray(mesh?.overlayMedia) ? mesh.overlayMedia : (mesh?.overlayMedia ? [mesh.overlayMedia] : []);
      overlayArray.forEach((overlay, overlayIndex) => {
        overlayContainer.appendChild(createOverlayMediaItem(arrayKey, index, overlayIndex, overlay));
      });
      const addOverlayBtn = document.createElement('button');
      addOverlayBtn.type = 'button';
      addOverlayBtn.className = 'btn-add';
      addOverlayBtn.textContent = 'æ·»åŠ è¦†ç›–åª’ä½“';
      addOverlayBtn.onclick = () => {
        overlayContainer.appendChild(createOverlayMediaItem(arrayKey, index, overlayContainer.children.length, {}));
        updateFormData();
        updateNavigation();
      };
      overlaySection.appendChild(overlayContainer);
      overlaySection.appendChild(addOverlayBtn);
      container.appendChild(overlaySection);

      // Special Effect Triggers
      const specialEffectSection = document.createElement('div');
      specialEffectSection.className = 'nested-section';
      specialEffectSection.id = `${arrayKey}-${index}-specialEffectTriggers`;
      const specialEffectTitle = document.createElement('div');
      specialEffectTitle.className = 'form-section-title';
      specialEffectTitle.style.fontSize = '14px';
      specialEffectTitle.style.marginBottom = '10px';
      specialEffectTitle.textContent = 'ç‰¹æ®Šç‰¹æ•ˆè§¦å‘';
      specialEffectSection.appendChild(specialEffectTitle);
      const specialEffectContainer = document.createElement('div');
      specialEffectContainer.id = `specialEffectTriggers-${arrayKey}-${index}`;
      const specialEffectArray = Array.isArray(mesh?.specialEffectTriggers) ? mesh.specialEffectTriggers : (mesh?.specialEffectTriggers ? [mesh.specialEffectTriggers] : []);
      specialEffectArray.forEach((trigger, triggerIndex) => {
        specialEffectContainer.appendChild(createSpecialEffectTriggerItem(arrayKey, index, triggerIndex, trigger));
      });
      const addSpecialEffectBtn = document.createElement('button');
      addSpecialEffectBtn.type = 'button';
      addSpecialEffectBtn.className = 'btn-add';
      addSpecialEffectBtn.textContent = 'æ·»åŠ ç‰¹æ®Šç‰¹æ•ˆè§¦å‘';
      addSpecialEffectBtn.onclick = () => {
        specialEffectContainer.appendChild(createSpecialEffectTriggerItem(arrayKey, index, specialEffectContainer.children.length, {}));
        updateFormData();
        updateNavigation();
      };
      specialEffectSection.appendChild(specialEffectContainer);
      specialEffectSection.appendChild(addSpecialEffectBtn);
      container.appendChild(specialEffectSection);

      // Slot Hide Rules
      const slotHideRulesSection = document.createElement('div');
      slotHideRulesSection.className = 'nested-section';
      slotHideRulesSection.id = `${arrayKey}-${index}-slotHideRules`;
      const slotHideRulesTitle = document.createElement('div');
      slotHideRulesTitle.className = 'form-section-title';
      slotHideRulesTitle.style.fontSize = '14px';
      slotHideRulesTitle.style.marginBottom = '10px';
      slotHideRulesTitle.textContent = 'æ’æ§½éšè—è§„åˆ™';
      slotHideRulesSection.appendChild(slotHideRulesTitle);
      const slotHideRulesContainer = document.createElement('div');
      slotHideRulesContainer.id = `slotHideRules-${arrayKey}-${index}`;
      (mesh?.slotHideRules || []).forEach((rule, ruleIndex) => {
        slotHideRulesContainer.appendChild(createSlotHideRuleItem(arrayKey, index, ruleIndex, rule));
      });
      const addSlotHideRuleBtn = document.createElement('button');
      addSlotHideRuleBtn.type = 'button';
      addSlotHideRuleBtn.className = 'btn-add';
      addSlotHideRuleBtn.textContent = 'æ·»åŠ æ’æ§½éšè—è§„åˆ™';
      addSlotHideRuleBtn.onclick = () => {
        slotHideRulesContainer.appendChild(createSlotHideRuleItem(arrayKey, index, slotHideRulesContainer.children.length, {}));
        updateFormData();
        updateNavigation();
      };
      slotHideRulesSection.appendChild(slotHideRulesContainer);
      slotHideRulesSection.appendChild(addSlotHideRuleBtn);
      container.appendChild(slotHideRulesSection);

      return container;
    }

    // åˆ›å»ºåŠ¨ç”»é¡¹
    function createAnimationItem(arrayKey, meshIndex, animIndex, anim) {
      const item = document.createElement('div');
      item.className = 'array-item';

      const header = document.createElement('div');
      header.className = 'array-item-header';
      header.innerHTML = `
        <div class="array-item-title">åŠ¨ç”» #${animIndex + 1}</div>
        <button type="button" class="btn-remove" onclick="this.closest('.array-item').remove(); updateFormData(); updateNavigation();">åˆ é™¤</button>
      `;
      item.appendChild(header);

      item.appendChild(createFieldGroup(`${arrayKey}[${meshIndex}].animations[${animIndex}].name`, 'åŠ¨ç”»åç§°', 'string', anim?.name));
      item.appendChild(createFieldGroup(`${arrayKey}[${meshIndex}].animations[${animIndex}].weight`, 'æƒé‡ (0-100)', 'number', anim?.weight));
      item.appendChild(createFieldGroup(`${arrayKey}[${meshIndex}].animations[${animIndex}].audioFileName`, 'éŸ³é¢‘æ–‡ä»¶å', 'string', anim?.audioFileName));

      return item;
    }

    // åˆ›å»ºç‚¹å‡»ç‰¹æ•ˆé¡¹
    function createClickEffectItem(arrayKey, meshIndex, effectIndex, effect) {
      const item = document.createElement('div');
      item.className = 'array-item';

      const header = document.createElement('div');
      header.className = 'array-item-header';
      header.innerHTML = `
        <div class="array-item-title">ç‚¹å‡»ç‰¹æ•ˆ #${effectIndex + 1}</div>
        <button type="button" class="btn-remove" onclick="this.closest('.array-item').remove(); updateFormData(); updateNavigation();">åˆ é™¤</button>
      `;
      item.appendChild(header);

      item.appendChild(createFieldGroup(`${arrayKey}[${meshIndex}].clickEffects[${effectIndex}].imageFileName`, 'å›¾ç‰‡æ–‡ä»¶å', 'string', effect?.imageFileName));
      item.appendChild(createFieldGroup(`${arrayKey}[${meshIndex}].clickEffects[${effectIndex}].weight`, 'æƒé‡ (0-100)', 'number', effect?.weight));
      item.appendChild(createFieldGroup(`${arrayKey}[${meshIndex}].clickEffects[${effectIndex}].duration`, 'æŒç»­æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰', 'number', effect?.duration));
      item.appendChild(createFieldGroup(`${arrayKey}[${meshIndex}].clickEffects[${effectIndex}].scale`, 'ç¼©æ”¾æ¯”ä¾‹', 'number', effect?.scale));
      item.appendChild(createFieldGroup(`${arrayKey}[${meshIndex}].clickEffects[${effectIndex}].effect`, 'åŠ¨ç”»æ•ˆæœ (0=æ— ,1=æ‘‡æ™ƒ,2=æ”¾å¤§ç¼©å°)', 'number', effect?.effect));

      return item;
    }

    // åˆ›å»ºè¦†ç›–åª’ä½“é¡¹
    function createOverlayMediaItem(arrayKey, meshIndex, overlayIndex, overlay) {
      const item = document.createElement('div');
      item.className = 'array-item';

      const header = document.createElement('div');
      header.className = 'array-item-header';
      header.innerHTML = `
        <div class="array-item-title">è¦†ç›–åª’ä½“ #${overlayIndex + 1}</div>
        <button type="button" class="btn-remove" onclick="this.closest('.array-item').remove(); updateFormData(); updateNavigation();">åˆ é™¤</button>
      `;
      item.appendChild(header);

      item.appendChild(createFieldGroup(`${arrayKey}[${meshIndex}].overlayMedia[${overlayIndex}].triggerSlot`, 'è§¦å‘æ’æ§½ï¼ˆå­—ç¬¦ä¸²æˆ–æ•°ç»„ï¼‰', 'stringOrArray', overlay?.triggerSlot));
      item.appendChild(createFieldGroup(`${arrayKey}[${meshIndex}].overlayMedia[${overlayIndex}].triggerSlotsWhenHidden`, 'éšè—æ—¶è§¦å‘æ’æ§½ï¼ˆå­—ç¬¦ä¸²æˆ–æ•°ç»„ï¼‰', 'stringOrArray', overlay?.triggerSlotsWhenHidden));
      item.appendChild(createFieldGroup(`${arrayKey}[${meshIndex}].overlayMedia[${overlayIndex}].triggerEffectsWhenActive`, 'æ¿€æ´»æ—¶è§¦å‘ç‰¹æ•ˆï¼ˆå­—ç¬¦ä¸²æˆ–æ•°ç»„ï¼‰', 'stringOrArray', overlay?.triggerEffectsWhenActive));
      item.appendChild(createFieldGroup(`${arrayKey}[${meshIndex}].overlayMedia[${overlayIndex}].videoFileName`, 'è§†é¢‘æ–‡ä»¶åï¼ˆå­—ç¬¦ä¸²æˆ–æ•°ç»„ï¼‰', 'stringOrArray', overlay?.videoFileName));
      item.appendChild(createFieldGroup(`${arrayKey}[${meshIndex}].overlayMedia[${overlayIndex}].audioFileName`, 'éŸ³é¢‘æ–‡ä»¶å', 'string', overlay?.audioFileName));
      item.appendChild(createFieldGroup(`${arrayKey}[${meshIndex}].overlayMedia[${overlayIndex}].muteVideo`, 'é™éŸ³è§†é¢‘', 'boolean', overlay?.muteVideo));
      item.appendChild(createFieldGroup(`${arrayKey}[${meshIndex}].overlayMedia[${overlayIndex}].closeOnClick`, 'ç‚¹å‡»å…³é—­', 'boolean', overlay?.closeOnClick));
      item.appendChild(createFieldGroup(`${arrayKey}[${meshIndex}].overlayMedia[${overlayIndex}].pauseBackgroundMusic`, 'æš‚åœèƒŒæ™¯éŸ³ä¹', 'boolean', overlay?.pauseBackgroundMusic));
      item.appendChild(createFieldGroup(`${arrayKey}[${meshIndex}].overlayMedia[${overlayIndex}].videoVolume`, 'è§†é¢‘éŸ³é‡ (0-1)', 'number', overlay?.videoVolume));
      item.appendChild(createFieldGroup(`${arrayKey}[${meshIndex}].overlayMedia[${overlayIndex}].audioVolume`, 'éŸ³é¢‘éŸ³é‡ (0-1)', 'number', overlay?.audioVolume));
      item.appendChild(createFieldGroup(`${arrayKey}[${meshIndex}].overlayMedia[${overlayIndex}].loopVideo`, 'å¾ªç¯è§†é¢‘', 'boolean', overlay?.loopVideo));
      item.appendChild(createFieldGroup(`${arrayKey}[${meshIndex}].overlayMedia[${overlayIndex}].switchToMeshIndex`, 'åˆ‡æ¢åˆ° Mesh ç´¢å¼•', 'number', overlay?.switchToMeshIndex));

      return item;
    }

    // åˆ›å»ºç‰¹æ®Šç‰¹æ•ˆè§¦å‘é¡¹
    function createSpecialEffectTriggerItem(arrayKey, meshIndex, triggerIndex, trigger) {
      const item = document.createElement('div');
      item.className = 'array-item';

      const header = document.createElement('div');
      header.className = 'array-item-header';
      header.innerHTML = `
        <div class="array-item-title">ç‰¹æ®Šç‰¹æ•ˆè§¦å‘ #${triggerIndex + 1}</div>
        <button type="button" class="btn-remove" onclick="this.closest('.array-item').remove(); updateFormData(); updateNavigation();">åˆ é™¤</button>
      `;
      item.appendChild(header);

      item.appendChild(createFieldGroup(`${arrayKey}[${meshIndex}].specialEffectTriggers[${triggerIndex}].triggerSlot`, 'è§¦å‘æ’æ§½ï¼ˆå­—ç¬¦ä¸²æˆ–æ•°ç»„ï¼‰', 'stringOrArray', trigger?.triggerSlot));
      item.appendChild(createFieldGroup(`${arrayKey}[${meshIndex}].specialEffectTriggers[${triggerIndex}].triggerSlotsWhenHidden`, 'éšè—æ—¶è§¦å‘æ’æ§½ï¼ˆå­—ç¬¦ä¸²æˆ–æ•°ç»„ï¼‰', 'stringOrArray', trigger?.triggerSlotsWhenHidden));
      item.appendChild(createFieldGroup(`${arrayKey}[${meshIndex}].specialEffectTriggers[${triggerIndex}].triggerEffectsWhenActive`, 'æ¿€æ´»æ—¶è§¦å‘ç‰¹æ•ˆï¼ˆå­—ç¬¦ä¸²æˆ–æ•°ç»„ï¼‰', 'stringOrArray', trigger?.triggerEffectsWhenActive));
      // å½“ç‰¹æ•ˆå›¾ç‰‡æ•°é‡è¾¾åˆ°æ—¶è§¦å‘
      item.appendChild(
        createArrayFieldInline(
          `${arrayKey}[${meshIndex}].specialEffectTriggers[${triggerIndex}].triggerEffectsWhenCountReached`,
          'ç‰¹æ•ˆæ•°é‡è§¦å‘',
          [
            { key: 'imageFileName', label: 'ç‰¹æ•ˆå›¾ç‰‡æ–‡ä»¶å', type: 'string' },
            { key: 'count', label: 'éœ€è¦è¾¾åˆ°çš„ä¸ªæ•°', type: 'number' }
          ],
          trigger?.triggerEffectsWhenCountReached
        )
      );
      // ç´¯è®¡æ¬¡æ•°è§¦å‘
      item.appendChild(
        createArrayFieldInline(
          `${arrayKey}[${meshIndex}].specialEffectTriggers[${triggerIndex}].triggerEffectsWhenTotalCountReached`,
          'ç‰¹æ•ˆç´¯è®¡è§¦å‘',
          [
            {
              key: 'effectIdentifier',
              label: 'ç‰¹æ•ˆæ ‡è¯†ï¼ˆimage æˆ– effect:ç´¢å¼•ï¼‰',
              type: 'string'
            },
            { key: 'count', label: 'ç´¯è®¡æ¬¡æ•°', type: 'number' }
          ],
          trigger?.triggerEffectsWhenTotalCountReached
        )
      );

      item.appendChild(createFieldGroup(`${arrayKey}[${meshIndex}].specialEffectTriggers[${triggerIndex}].effectIndices`, 'ç‰¹æ•ˆç´¢å¼•ï¼ˆæ•°ç»„æˆ–äºŒç»´æ•°ç»„ï¼‰', 'stringOrArray', trigger?.effectIndices));
      item.appendChild(createFieldGroup(`${arrayKey}[${meshIndex}].specialEffectTriggers[${triggerIndex}].random`, 'éšæœºé€‰æ‹©', 'boolean', trigger?.random));

      return item;
    }

    // åˆ›å»ºæ’æ§½éšè—è§„åˆ™é¡¹
    function createSlotHideRuleItem(arrayKey, meshIndex, ruleIndex, rule) {
      const item = document.createElement('div');
      item.className = 'array-item';

      const header = document.createElement('div');
      header.className = 'array-item-header';
      header.innerHTML = `
        <div class="array-item-title">æ’æ§½éšè—è§„åˆ™ #${ruleIndex + 1}</div>
        <button type="button" class="btn-remove" onclick="this.closest('.array-item').remove(); updateFormData(); updateNavigation();">åˆ é™¤</button>
      `;
      item.appendChild(header);

      item.appendChild(createFieldGroup(`${arrayKey}[${meshIndex}].slotHideRules[${ruleIndex}].triggerSlots`, 'è§¦å‘æ’æ§½ï¼ˆå­—ç¬¦ä¸²æˆ–æ•°ç»„ï¼‰', 'stringOrArray', rule?.triggerSlots));
      item.appendChild(createFieldGroup(`${arrayKey}[${meshIndex}].slotHideRules[${ruleIndex}].hideSlots`, 'éšè—æ’æ§½ï¼ˆå­—ç¬¦ä¸²æˆ–æ•°ç»„ï¼‰', 'stringOrArray', rule?.hideSlots));
      item.appendChild(createFieldGroup(`${arrayKey}[${meshIndex}].slotHideRules[${ruleIndex}].hideDuration`, 'éšè—æŒç»­æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰', 'number', rule?.hideDuration));

      return item;
    }

    // åˆ›å»ºç‰¹æ®Šç‰¹æ•ˆå­—æ®µ
    function createSpecialEffectFields(arrayKey, index, effect) {
      const container = document.createElement('div');

      const typeGroup = createFieldGroup(`${arrayKey}[${index}].type`, 'ç‰¹æ•ˆç±»å‹', 'select', effect?.type, [1, 2, 3, 4, 5]);
      container.appendChild(typeGroup);

      const type = effect?.type || 1;

      if (type === 1) {
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].image1FileName`, 'ç¬¬ä¸€å¼ å›¾ç‰‡æ–‡ä»¶å', 'string', effect?.image1FileName));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].image1Duration`, 'ç¬¬ä¸€å¼ å›¾ç‰‡æŒç»­æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰', 'number', effect?.image1Duration));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].image1Scale`, 'ç¬¬ä¸€å¼ å›¾ç‰‡ç¼©æ”¾æ¯”ä¾‹', 'number', effect?.image1Scale));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].fadeOutDuration`, 'æ¸éšæ¶ˆå¤±æŒç»­æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰', 'number', effect?.fadeOutDuration));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].audioFileName`, 'éŸ³é¢‘æ–‡ä»¶å', 'string', effect?.audioFileName));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].animationName`, 'åŠ¨ç”»åç§°', 'string', effect?.animationName));
      } else if (type === 2) {
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].image1FileName`, 'ç¬¬ä¸€å¼ å›¾ç‰‡æ–‡ä»¶å', 'string', effect?.image1FileName));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].image2FileName`, 'ç¬¬äºŒå¼ å›¾ç‰‡æ–‡ä»¶å', 'string', effect?.image2FileName));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].image3FileName`, 'ç¬¬ä¸‰å¼ å›¾ç‰‡æ–‡ä»¶å', 'string', effect?.image3FileName));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].image1Duration`, 'ç¬¬ä¸€å¼ å›¾ç‰‡æŒç»­æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰', 'number', effect?.image1Duration));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].image1Scale`, 'ç¬¬ä¸€å¼ å›¾ç‰‡ç¼©æ”¾æ¯”ä¾‹', 'number', effect?.image1Scale));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].scaleDuration`, 'ç¼©æ”¾åŠ¨ç”»æŒç»­æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰', 'number', effect?.scaleDuration));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].fadeOutDuration`, 'æ¸éšæ¶ˆå¤±æŒç»­æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰', 'number', effect?.fadeOutDuration));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].image2InitialScale`, 'ç¬¬äºŒå¼ å›¾ç‰‡åˆå§‹ç¼©æ”¾æ¯”ä¾‹', 'number', effect?.image2InitialScale));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].image2FinalScale`, 'ç¬¬äºŒå¼ å›¾ç‰‡æœ€ç»ˆç¼©æ”¾æ¯”ä¾‹', 'number', effect?.image2FinalScale));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].image3InitialScale`, 'ç¬¬ä¸‰å¼ å›¾ç‰‡åˆå§‹ç¼©æ”¾æ¯”ä¾‹', 'number', effect?.image3InitialScale));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].image3FinalScale`, 'ç¬¬ä¸‰å¼ å›¾ç‰‡æœ€ç»ˆç¼©æ”¾æ¯”ä¾‹', 'number', effect?.image3FinalScale));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].image2AlignPercent`, 'ç¬¬äºŒå¼ å›¾ç‰‡å¯¹é½ä½ç½®ï¼ˆç™¾åˆ†æ¯”ï¼‰', 'number', effect?.image2AlignPercent));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].audioFileName`, 'éŸ³é¢‘æ–‡ä»¶å', 'string', effect?.audioFileName));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].animationName`, 'åŠ¨ç”»åç§°', 'string', effect?.animationName));
      } else if (type === 3) {
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].image1FileName`, 'å›¾ç‰‡æ–‡ä»¶å', 'string', effect?.image1FileName));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].initialScale`, 'åˆå§‹ç¼©æ”¾æ¯”ä¾‹', 'number', effect?.initialScale));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].finalScale`, 'æœ€ç»ˆç¼©æ”¾æ¯”ä¾‹', 'number', effect?.finalScale));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].enterDuration`, 'è¿›å…¥æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰', 'number', effect?.enterDuration));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].stayDuration`, 'åœç•™æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰', 'number', effect?.stayDuration));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].fadeOutDuration`, 'æ¸éšæ¶ˆå¤±æŒç»­æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰', 'number', effect?.fadeOutDuration));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].displayWidthRatio`, 'æ˜¾ç¤ºå®½åº¦æ¯”ä¾‹ (0-1)', 'number', effect?.displayWidthRatio));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].audioFileName`, 'éŸ³é¢‘æ–‡ä»¶å', 'string', effect?.audioFileName));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].animationName`, 'åŠ¨ç”»åç§°', 'string', effect?.animationName));
      } else if (type === 4) {
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].image1FileName`, 'å›¾ç‰‡æ–‡ä»¶å', 'string', effect?.image1FileName));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].initialScale`, 'åˆå§‹ç¼©æ”¾æ¯”ä¾‹', 'number', effect?.initialScale));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].finalScale`, 'æœ€ç»ˆç¼©æ”¾æ¯”ä¾‹', 'number', effect?.finalScale));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].scaleDuration`, 'ç¼©æ”¾åŠ¨ç”»æŒç»­æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰', 'number', effect?.scaleDuration));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].fadeOutDuration`, 'æ¸éšæ¶ˆå¤±æŒç»­æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰', 'number', effect?.fadeOutDuration));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].alignPercent`, 'å‚ç›´å¯¹é½ä½ç½®ï¼ˆç™¾åˆ†æ¯”ï¼‰', 'number', effect?.alignPercent));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].audioFileName`, 'éŸ³é¢‘æ–‡ä»¶å', 'string', effect?.audioFileName));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].animationName`, 'åŠ¨ç”»åç§°', 'string', effect?.animationName));
      } else if (type === 5) {
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].duration`, 'æŒç»­æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰', 'number', effect?.duration));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].audioFileName`, 'éŸ³é¢‘æ–‡ä»¶åï¼ˆå­—ç¬¦ä¸²æˆ–æ•°ç»„ï¼‰', 'stringOrArray', effect?.audioFileName));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].slotNames`, 'æ’æ§½åç§°ï¼ˆå­—ç¬¦ä¸²æˆ–æ•°ç»„ï¼‰', 'stringOrArray', effect?.slotNames));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].toggleIntervalRange`, 'åˆ‡æ¢é—´éš”èŒƒå›´ [min, max]ï¼ˆæ¯«ç§’ï¼‰', 'stringOrArray', effect?.toggleIntervalRange));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].showDelayRange`, 'æ˜¾ç¤ºå»¶è¿ŸèŒƒå›´ [min, max]ï¼ˆæ¯«ç§’ï¼‰', 'stringOrArray', effect?.showDelayRange));
        container.appendChild(createFieldGroup(`${arrayKey}[${index}].animationName`, 'åŠ¨ç”»åç§°', 'string', effect?.animationName));
      }

      return container;
    }

    // åˆ›å»ºå­—æ®µç»„
    function createFieldGroup(fullKey, label, type, value, options) {
      const group = document.createElement('div');
      group.className = 'form-group';

      const labelEl = document.createElement('label');
      labelEl.textContent = label;
      labelEl.setAttribute('for', fullKey);
      group.appendChild(labelEl);

      let input;

      if (type === 'select') {
        input = document.createElement('select');
        input.id = fullKey;
        options.forEach(opt => {
          const option = document.createElement('option');
          option.value = opt;
          option.textContent = opt;
          if (value === opt) option.selected = true;
          input.appendChild(option);
        });
      } else if (type === 'boolean') {
        const wrapper = document.createElement('div');
        wrapper.className = 'checkbox-group';
        input = document.createElement('input');
        input.type = 'checkbox';
        input.id = fullKey;
        input.checked = value === true;
        wrapper.appendChild(input);
        wrapper.appendChild(document.createTextNode('å¯ç”¨'));
        group.appendChild(wrapper);
        input.addEventListener('change', () => updateFormData());
        return group;
      } else if (type === 'stringOrArray') {
        input = document.createElement('textarea');
        input.id = fullKey;
        input.placeholder = 'è¾“å…¥å­—ç¬¦ä¸²æˆ– JSON æ•°ç»„ï¼Œä¾‹å¦‚: "image.png" æˆ– ["img1.png", "img2.png"]';
        if (value !== undefined) {
          if (Array.isArray(value)) {
            input.value = JSON.stringify(value);
          } else {
            input.value = value;
          }
        }
      } else {
        input = document.createElement('input');
        input.id = fullKey;
        input.type = type === 'number' ? 'number' : 'text';
        if (value !== undefined && value !== null) input.value = value;
      }

      input.addEventListener('input', () => updateFormData());
      if (type === 'select') {
        input.addEventListener('change', () => {
          updateFormData();
          // å¦‚æœæ˜¯ç‰¹æ®Šç‰¹æ•ˆç±»å‹æ”¹å˜ï¼Œé‡æ–°æ¸²æŸ“
          if (fullKey.includes('.type') && fullKey.includes('specialEffectLibrary')) {
            const index = parseInt(fullKey.match(/\[(\d+)\]/)[1]);
            const arrayKey = fullKey.split('[')[0];
            const container = document.getElementById(`array-${arrayKey}`);
            if (container) {
              const itemDiv = container.children[index];
              if (itemDiv) {
                const content = itemDiv.querySelector('.array-item > div:last-child');
                if (content) {
                  const newType = parseInt(input.value);
                  const oldContent = content.innerHTML;
                  content.innerHTML = '';
                  const newFields = createSpecialEffectFields(arrayKey, index, { type: newType });
                  content.appendChild(newFields);
                }
              }
            }
          }
        });
      }
      group.appendChild(input);

      return group;
    }

    // è·å–ç±»å‹çš„é»˜è®¤å€¼
    function getDefaultValueForType(type) {
      if (type === 'mesh') {
        return { type: 'spine', scale: 1, position: { x: 0, y: 0, z: 0 } };
      } else if (type === 'specialEffect') {
        return { type: 1 };
      }
      return {};
    }

    function createSlotClickEffectItem(arrayKey, meshIndex, itemIndex, item) {
      const wrapper = document.createElement('div');
      wrapper.className = 'array-item';

      const header = document.createElement('div');
      header.className = 'array-item-header';
      header.innerHTML = `
    <div class="array-item-title">æ’æ§½ç‚¹å‡»ç‰¹æ•ˆ #${itemIndex + 1}</div>
    <button type="button" class="btn-remove"
      onclick="this.closest('.array-item').remove(); updateFormData(); updateNavigation();">
      åˆ é™¤
    </button>
  `;
      wrapper.appendChild(header);

      // è§¦å‘æ’æ§½
      wrapper.appendChild(
        createFieldGroup(
          `${arrayKey}[${meshIndex}].slotClickEffects[${itemIndex}].triggerSlots`,
          'è§¦å‘æ’æ§½ï¼ˆå­—ç¬¦ä¸²æˆ–æ•°ç»„ï¼‰',
          'stringOrArray',
          item?.triggerSlots
        )
      );

      // effects
      const effectsContainer = document.createElement('div');
      effectsContainer.className = 'nested-section';

      const effectsTitle = document.createElement('div');
      effectsTitle.className = 'form-section-title';
      effectsTitle.style.fontSize = '13px';
      effectsTitle.style.marginBottom = '8px';
      effectsTitle.textContent = 'ç‰¹æ•ˆé…ç½®';
      effectsContainer.appendChild(effectsTitle);

      const effectsList = document.createElement('div');

      (item?.effects || []).forEach((effect, effectIndex) => {
        effectsList.appendChild(
          createClickEffectItem(
            `${arrayKey}[${meshIndex}].slotClickEffects[${itemIndex}].effects`,
            '',
            effectIndex,
            effect
          )
        );
      });

      const addEffectBtn = document.createElement('button');
      addEffectBtn.type = 'button';
      addEffectBtn.className = 'btn-add';
      addEffectBtn.textContent = 'æ·»åŠ ç‰¹æ•ˆ';
      addEffectBtn.onclick = () => {
        effectsList.appendChild(
          createClickEffectItem(
            `${arrayKey}[${meshIndex}].slotClickEffects[${itemIndex}].effects`,
            '',
            effectsList.children.length,
            {}
          )
        );
        updateFormData();
        updateNavigation();
      };

      effectsContainer.appendChild(effectsList);
      effectsContainer.appendChild(addEffectBtn);

      wrapper.appendChild(effectsContainer);
      return wrapper;
    }

    function createArrayFieldInline(baseKey, title, fields, valueArray = []) {
      const section = document.createElement('div');
      section.className = 'nested-section';

      const titleEl = document.createElement('div');
      titleEl.className = 'form-section-title';
      titleEl.style.fontSize = '13px';
      titleEl.style.marginBottom = '8px';
      titleEl.textContent = title;
      section.appendChild(titleEl);

      const container = document.createElement('div');

      (valueArray || []).forEach((item, index) => {
        container.appendChild(
          createInlineArrayItem(baseKey, index, fields, item)
        );
      });

      const addBtn = document.createElement('button');
      addBtn.type = 'button';
      addBtn.className = 'btn-add';
      addBtn.textContent = 'æ·»åŠ ';
      addBtn.onclick = () => {
        container.appendChild(
          createInlineArrayItem(
            baseKey,
            container.children.length,
            fields,
            {}
          )
        );
        updateFormData();
        updateNavigation();
      };

      section.appendChild(container);
      section.appendChild(addBtn);
      return section;
    }

    function createInlineArrayItem(baseKey, index, fields, value) {
      const item = document.createElement('div');
      item.className = 'array-item';

      const header = document.createElement('div');
      header.className = 'array-item-header';
      header.innerHTML = `
    <div class="array-item-title">é¡¹ #${index + 1}</div>
    <button type="button" class="btn-remove"
      onclick="this.closest('.array-item').remove(); updateFormData(); updateNavigation();">
      åˆ é™¤
    </button>
  `;
      item.appendChild(header);

      fields.forEach(field => {
        item.appendChild(
          createFieldGroup(
            `${baseKey}[${index}].${field.key}`,
            field.label,
            field.type,
            value?.[field.key]
          )
        );
      });

      return item;
    }



    // æ›´æ–°è¡¨å•æ•°æ®
    function updateFormData() {
      formData = {};

      // æ”¶é›†æ‰€æœ‰è¾“å…¥å€¼
      document.querySelectorAll('input, select, textarea').forEach(input => {
        if (!input.id) return;

        const id = input.id;
        let value;

        if (input.type === 'checkbox') {
          value = input.checked ? true : undefined;
        } else if (input.type === 'number') {
          value = input.value === '' ? undefined : parseFloat(input.value);
        } else if (input.tagName === 'SELECT') {
          const selectValue = input.value;
          if (selectValue === '') {
            value = undefined;
          } else {
            // å°è¯•è§£æä¸ºæ•°å­—
            const numValue = parseFloat(selectValue);
            value = isNaN(numValue) ? selectValue : numValue;
          }
        } else {
          const strValue = input.value.trim();
          if (strValue === '') {
            value = undefined;
          } else {
            // å°è¯•è§£æä¸º JSONï¼ˆç”¨äºæ•°ç»„å’Œå¯¹è±¡ï¼‰
            try {
              value = JSON.parse(strValue);
            } catch {
              value = strValue;
            }
          }
        }

        if (value === undefined || value === '') return;

        // è§£æ ID è·¯å¾„
        setNestedValue(formData, id, value);
      });
    }

    // è®¾ç½®åµŒå¥—å€¼
    function setNestedValue(obj, path, value) {
      // å¤„ç†æ•°ç»„ç´¢å¼•ï¼Œå¦‚ meshes[0].scale æˆ– meshes[0].animations[1].name
      const parts = [];
      let current = '';
      let bracketMode = false;

      for (let i = 0; i < path.length; i++) {
        const char = path[i];
        if (char === '[') {
          if (current) {
            parts.push({ type: 'key', value: current });
            current = '';
          }
          bracketMode = true;
        } else if (char === ']') {
          parts.push({ type: 'index', value: parseInt(current) });
          current = '';
          bracketMode = false;
        } else if (char === '.' && !bracketMode) {
          if (current) {
            parts.push({ type: 'key', value: current });
            current = '';
          }
        } else {
          current += char;
        }
      }
      if (current) {
        parts.push({ type: 'key', value: current });
      }

      // æ„å»ºåµŒå¥—å¯¹è±¡
      let currentObj = obj;
      for (let i = 0; i < parts.length - 1; i++) {
        const part = parts[i];
        const nextPart = parts[i + 1];

        if (part.type === 'key') {
          if (!currentObj[part.value]) {
            currentObj[part.value] = nextPart.type === 'index' ? [] : {};
          }
          currentObj = currentObj[part.value];
        } else if (part.type === 'index') {
          if (!Array.isArray(currentObj)) {
            currentObj = [];
          }
          while (currentObj.length <= part.value) {
            currentObj.push({});
          }
          if (!currentObj[part.value]) {
            currentObj[part.value] = nextPart.type === 'index' ? [] : {};
          }
          currentObj = currentObj[part.value];
        }
      }

      // è®¾ç½®æœ€ç»ˆå€¼
      const lastPart = parts[parts.length - 1];
      if (lastPart.type === 'key') {
        currentObj[lastPart.value] = value;
      } else if (lastPart.type === 'index') {
        if (!Array.isArray(currentObj)) {
          currentObj = [];
        }
        while (currentObj.length <= lastPart.value) {
          currentObj.push(undefined);
        }
        currentObj[lastPart.value] = value;
      }
    }


    // å¯¼å‡ºé…ç½®
    function exportConfig() {
      updateFormData();

      // æ¸…ç†ç©ºå€¼ï¼ˆéµå¾ªæœ€ç®€åŸåˆ™ï¼‰
      const cleaned = cleanEmptyValues(formData);

      const json = JSON.stringify(cleaned, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'config.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    // æ¸…ç†ç©ºå€¼ï¼ˆéµå¾ªæœ€ç®€åŸåˆ™ï¼šåªä¿ç•™æœ‰å€¼çš„å­—æ®µï¼‰
    function cleanEmptyValues(obj) {
      if (obj === null || obj === undefined) return undefined;

      // ä¿ç•™ boolean ç±»å‹çš„ false å€¼
      if (typeof obj === 'boolean') return obj;

      // ä¿ç•™æ•°å­— 0
      if (typeof obj === 'number') return obj;

      if (Array.isArray(obj)) {
        const cleaned = obj.map(cleanEmptyValues).filter(v => v !== undefined);
        return cleaned.length > 0 ? cleaned : undefined;
      }

      if (typeof obj === 'object') {
        const cleaned = {};
        Object.keys(obj).forEach(key => {
          const value = cleanEmptyValues(obj[key]);
          if (value !== undefined) {
            cleaned[key] = value;
          }
        });
        return Object.keys(cleaned).length > 0 ? cleaned : undefined;
      }

      // å­—ç¬¦ä¸²ï¼šç©ºå­—ç¬¦ä¸²è§†ä¸º undefined
      if (typeof obj === 'string' && obj.trim() === '') return undefined;

      return obj;
    }

    // å¯¼å…¥é…ç½®
    document.getElementById('importFile').addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const imported = JSON.parse(e.target.result);
          formData = imported;
          initForm(); // initForm ä¼šè‡ªåŠ¨è°ƒç”¨ updateNavigation å’Œ initNavigationControls
        } catch (error) {
          alert('å¯¼å…¥å¤±è´¥ï¼š' + error.message);
        }
      };
      reader.readAsText(file);
    });

    // åˆå§‹åŒ–
    initForm();
  </script>
</body>

</html>